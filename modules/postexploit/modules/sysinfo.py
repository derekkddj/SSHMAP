"""
System information collection module.

Gathers basic system information from the remote host including:
- OS details
- Kernel version
- Hardware information
- Network configuration
- Current users
"""

from typing import Dict, Any
from modules.postexploit.base_module import BaseModule


class SystemInfoModule(BaseModule):
    """Collect system information from remote host."""
    
    _name = "sysinfo"
    
    @property
    def name(self) -> str:
        return "sysinfo"
    
    @property
    def description(self) -> str:
        return "Collect basic system information (OS, kernel, hardware, network, users)"
    
    @property
    def category(self) -> str:
        return "recon"
    
    async def run(self) -> Dict[str, Any]:
        """
        Collect system information from the remote host.
        
        Returns:
            Dictionary with system information
        """
        self.log_info(f"Collecting system information from {self.get_hostname()}")
        
        try:
            results = {
                'success': True,
                'hostname': self.get_hostname(),
                'data': {}
            }
            
            # OS information
            try:
                os_info = await self.execute_command("cat /etc/os-release 2>/dev/null || uname -a")
                results['data']['os_info'] = os_info.strip()
            except Exception as e:
                self.log_warning(f"Could not get OS info: {e}")
                results['data']['os_info'] = None
            
            # Kernel version
            try:
                kernel = await self.execute_command("uname -r")
                results['data']['kernel'] = kernel.strip()
            except Exception as e:
                self.log_warning(f"Could not get kernel version: {e}")
                results['data']['kernel'] = None
            
            # CPU information
            try:
                cpu_info = await self.execute_command("grep -m 1 'model name' /proc/cpuinfo | cut -d: -f2 | xargs")
                results['data']['cpu'] = cpu_info.strip() if cpu_info else "Unknown"
            except Exception as e:
                self.log_warning(f"Could not get CPU info: {e}")
                results['data']['cpu'] = None
            
            # Memory information
            try:
                mem_info = await self.execute_command("free -h | grep Mem:")
                results['data']['memory'] = mem_info.strip()
            except Exception as e:
                self.log_warning(f"Could not get memory info: {e}")
                results['data']['memory'] = None
            
            # Network interfaces
            try:
                net_info = await self.execute_command("ip addr show 2>/dev/null || ifconfig")
                results['data']['network_interfaces'] = net_info.strip()
            except Exception as e:
                self.log_warning(f"Could not get network info: {e}")
                results['data']['network_interfaces'] = None
            
            # Current users
            try:
                users = await self.execute_command("who")
                results['data']['logged_users'] = users.strip()
            except Exception as e:
                self.log_warning(f"Could not get logged users: {e}")
                results['data']['logged_users'] = None
            
            # System uptime
            try:
                uptime = await self.execute_command("uptime")
                results['data']['uptime'] = uptime.strip()
            except Exception as e:
                self.log_warning(f"Could not get uptime: {e}")
                results['data']['uptime'] = None
            
            self.log_success(f"Successfully collected system information from {self.get_hostname()}")
            return results
            
        except Exception as e:
            self.log_error(f"Failed to collect system information: {e}")
            return {
                'success': False,
                'hostname': self.get_hostname(),
                'error': str(e),
                'data': {}
            }
