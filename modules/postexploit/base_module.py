"""
Base module class for post-exploitation modules.

All post-exploitation modules should inherit from BaseModule and implement
the required methods.
"""

from abc import ABC, abstractmethod
from typing import Dict, Any, Optional
from modules.SSHSession import SSHSession
from modules.logger import sshmap_logger


class BaseModule(ABC):
    """
    Abstract base class for post-exploitation modules.
    
    Each module should:
    - Define a unique name and description
    - Implement the run() method to perform its functionality
    - Use the provided SSH session to execute remote commands
    - Return results in a structured format
    """
    
    def __init__(self, ssh_session: SSHSession):
        """
        Initialize the module with an SSH session.
        
        Args:
            ssh_session: An active SSHSession instance for command execution
        """
        self.ssh_session = ssh_session
        self.logger = sshmap_logger
        self.results = {}
    
    @property
    @abstractmethod
    def name(self) -> str:
        """Return the unique name of the module."""
        pass
    
    @property
    @abstractmethod
    def description(self) -> str:
        """Return a description of what the module does."""
        pass
    
    @property
    def category(self) -> str:
        """Return the category of the module (e.g., 'recon', 'exfil', 'persist')."""
        return "general"
    
    @abstractmethod
    async def run(self) -> Dict[str, Any]:
        """
        Execute the module's main functionality.
        
        Returns:
            Dict containing the module results with at least:
            - 'success': bool indicating if module ran successfully
            - 'data': Any data collected by the module
            - 'error': Optional error message if success is False
        """
        pass
    
    async def execute_command(self, command: str) -> str:
        """
        Execute a command on the remote host via SSH.
        
        Args:
            command: The command to execute
            
        Returns:
            The stdout output from the command
            
        Raises:
            ValueError: If SSH connection is not established
        """
        try:
            output = await self.ssh_session.exec_command(command)
            return output
        except Exception as e:
            self.logger.error(f"[{self.name}] Error executing command '{command}': {e}")
            raise
    
    async def execute_command_with_stderr(self, command: str) -> tuple[str, str]:
        """
        Execute a command and get both stdout and stderr.
        
        Args:
            command: The command to execute
            
        Returns:
            Tuple of (stdout, stderr)
        """
        try:
            stdout, stderr = await self.ssh_session.exec_command_with_stderr(command)
            return stdout, stderr
        except Exception as e:
            self.logger.error(f"[{self.name}] Error executing command '{command}': {e}")
            raise
    
    def get_hostname(self) -> str:
        """Get the remote hostname of the SSH session."""
        return self.ssh_session.get_remote_hostname()
    
    def log_info(self, message: str):
        """Log an informational message."""
        self.logger.info(f"[{self.name}] {message}")
    
    def log_success(self, message: str):
        """Log a success message."""
        self.logger.success(f"[{self.name}] {message}")
    
    def log_error(self, message: str):
        """Log an error message."""
        self.logger.error(f"[{self.name}] {message}")
    
    def log_warning(self, message: str):
        """Log a warning message."""
        self.logger.warning(f"[{self.name}] {message}")
