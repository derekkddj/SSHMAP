"""Module registry for managing post-exploitation modules."""
import importlib
import os
import inspect
from typing import Dict, List, Type
from .base_module import BasePostExploitationModule
from modules.logger import sshmap_logger


class ModuleRegistry:
    """
    Registry for discovering and managing post-exploitation modules.
    
    Automatically discovers all modules in the modules/post_exploitation/modules
    directory and makes them available for execution.
    """
    
    def __init__(self):
        self._modules: Dict[str, Type[BasePostExploitationModule]] = {}
        self._discover_modules()
    
    def _discover_modules(self):
        """Automatically discover all post-exploitation modules."""
        # Get the directory containing the modules
        current_dir = os.path.dirname(os.path.abspath(__file__))
        modules_dir = os.path.join(current_dir, "modules")
        
        if not os.path.exists(modules_dir):
            sshmap_logger.warning(f"Post-exploitation modules directory not found: {modules_dir}")
            return
        
        # Scan for Python files in the modules directory
        for filename in os.listdir(modules_dir):
            if filename.endswith(".py") and not filename.startswith("_"):
                module_name = filename[:-3]
                try:
                    # Import the module
                    module_path = f"modules.post_exploitation.modules.{module_name}"
                    module = importlib.import_module(module_path)
                    
                    # Find all classes that inherit from BasePostExploitationModule
                    for name, obj in inspect.getmembers(module, inspect.isclass):
                        if (issubclass(obj, BasePostExploitationModule) and 
                            obj != BasePostExploitationModule):
                            instance = obj()
                            self._modules[instance.name] = obj
                            sshmap_logger.debug(f"Registered post-exploitation module: {instance.name}")
                
                except Exception as e:
                    sshmap_logger.error(f"Failed to load module {module_name}: {e}")
    
    def get_module(self, name: str) -> BasePostExploitationModule:
        """
        Get a module instance by name.
        
        Args:
            name: The name of the module to retrieve
            
        Returns:
            An instance of the requested module
            
        Raises:
            KeyError: If the module is not found
        """
        if name not in self._modules:
            raise KeyError(f"Module '{name}' not found. Available modules: {self.list_modules()}")
        return self._modules[name]()
    
    def list_modules(self) -> List[str]:
        """Return a list of all available module names."""
        return list(self._modules.keys())
    
    def get_all_modules(self) -> List[BasePostExploitationModule]:
        """Return instances of all available modules."""
        return [cls() for cls in self._modules.values()]
