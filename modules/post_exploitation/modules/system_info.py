"""Module for gathering basic system information from the remote host."""
import os
from typing import Dict, Any
from modules.post_exploitation.base_module import BasePostExploitationModule
from modules.logger import sshmap_logger


class SystemInfoModule(BasePostExploitationModule):
    """
    Gathers basic system information from the remote host.
    
    Collects:
    - OS information (uname, version, distribution)
    - Network configuration (interfaces, routes, connections)
    - User information (current user, all users, groups)
    - Process information
    - Installed packages
    - System resources (CPU, memory, disk)
    """
    
    @property
    def name(self) -> str:
        return "system_info"
    
    @property
    def description(self) -> str:
        return "Gather comprehensive system information from the remote host"
    
    async def execute(self, ssh_session, output_dir: str) -> Dict[str, Any]:
        """Execute system information gathering on the remote host."""
        try:
            hostname = await ssh_session.get_remote_hostname()
            sshmap_logger.info(f"[{self.name}] Gathering system information from {hostname}")
            
            results = {
                "success": True,
                "hostname": hostname,
                "data": {},
                "error": None
            }
            
            # Define commands to execute
            info_commands = {
                "os_info": "uname -a",
                "os_release": "cat /etc/os-release 2>/dev/null || cat /etc/lsb-release 2>/dev/null || echo 'Not available'",
                "kernel_version": "uname -r",
                "hostname": "hostname",
                "uptime": "uptime",
                "current_user": "whoami",
                "user_id": "id",
                "all_users": "cat /etc/passwd",
                "groups": "cat /etc/group",
                "sudoers": "cat /etc/sudoers 2>/dev/null || echo 'Permission denied'",
                "network_interfaces": "ip addr 2>/dev/null || ifconfig 2>/dev/null || echo 'Not available'",
                "routing_table": "ip route 2>/dev/null || route -n 2>/dev/null || echo 'Not available'",
                "dns_config": "cat /etc/resolv.conf 2>/dev/null || echo 'Not available'",
                "hosts_file": "cat /etc/hosts 2>/dev/null || echo 'Not available'",
                "active_connections": "ss -tunap 2>/dev/null || netstat -tunap 2>/dev/null || echo 'Not available'",
                "listening_ports": "ss -tuln 2>/dev/null || netstat -tuln 2>/dev/null || echo 'Not available'",
                "processes": "ps auxf 2>/dev/null || ps aux 2>/dev/null || echo 'Not available'",
                "cron_jobs": "crontab -l 2>/dev/null || echo 'No crontab'",
                "system_cron": "ls -la /etc/cron* 2>/dev/null || echo 'Not available'",
                "disk_usage": "df -h",
                "memory_info": "free -h 2>/dev/null || echo 'Not available'",
                "cpu_info": "cat /proc/cpuinfo 2>/dev/null | grep 'model name' | head -1 || echo 'Not available'",
                "environment": "env",
                "installed_packages_deb": "dpkg -l 2>/dev/null || echo 'Not a Debian-based system'",
                "installed_packages_rpm": "rpm -qa 2>/dev/null || echo 'Not an RPM-based system'",
                "suid_files": "find / -perm -4000 -type f 2>/dev/null | head -50 || echo 'Not available'",
                "writable_directories": "find / -writable -type d 2>/dev/null | head -50 || echo 'Not available'",
            }
            
            # Execute all commands and collect results
            all_output = []
            for cmd_name, cmd in info_commands.items():
                try:
                    sshmap_logger.debug(f"[{self.name}] Executing: {cmd_name}")
                    output = await ssh_session.exec_command(cmd)
                    results["data"][cmd_name] = output
                    all_output.append(f"{'='*80}\n{cmd_name.upper()}\n{'='*80}\n{output}\n\n")
                except Exception as e:
                    sshmap_logger.debug(f"[{self.name}] Error executing {cmd_name}: {e}")
                    results["data"][cmd_name] = f"Error: {str(e)}"
                    all_output.append(f"{'='*80}\n{cmd_name.upper()}\n{'='*80}\nError: {str(e)}\n\n")
            
            # Save all output to a single file
            output_file = os.path.join(output_dir, f"{hostname}_system_info.txt")
            with open(output_file, "w") as f:
                f.write(f"System Information Report\n")
                f.write(f"Host: {hostname}\n")
                f.write(f"{'='*80}\n\n")
                f.write("".join(all_output))
            
            sshmap_logger.display(f"[{self.name}] System information saved to {output_file}")
            
            return results
            
        except Exception as e:
            sshmap_logger.error(f"[{self.name}] Failed to gather system information: {e}")
            return {
                "success": False,
                "hostname": hostname if 'hostname' in locals() else "unknown",
                "data": None,
                "error": str(e)
            }
