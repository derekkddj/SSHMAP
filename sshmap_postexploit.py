#!/usr/bin/env python3
"""
SSHMAP Post-Exploitation Module Runner

CLI tool for running post-exploitation modules on compromised SSH hosts.
"""

import argparse
import asyncio
import sys
from datetime import datetime
from modules.config import CONFIG
from modules.graphdb import GraphDB
from modules.logger import sshmap_logger, setup_debug_logging
from modules.SSHSessionManager import SSHSessionManager
from modules.credential_store import CredentialStore
from modules.postexploit.runner import ModuleRunner
from modules.console import nxc_console
from modules.utils import get_local_info
from rich.table import Table
from rich.panel import Panel
from rich.json import JSON
import json
import subprocess

console = nxc_console

# Initialize the Neo4j graph database connection
graph = GraphDB(CONFIG["neo4j_uri"], CONFIG["neo4j_user"], CONFIG["neo4j_pass"])

# Date of running
currenttime = datetime.now().strftime('%Y%m%d_%H%M%S')


async def run_module_on_host(
    hostname: str,
    module_name: str,
    local_hostname: str,
    credential_store: CredentialStore,
    module_runner: ModuleRunner
):
    """
    Run a post-exploitation module on a specific host.
    """
    try:
        # Get SSH session to the target
        ssh_session_manager = SSHSessionManager(
            graphdb=graph, credential_store=credential_store
        )
        host_ssh = await ssh_session_manager.get_session(hostname, local_hostname)
        
        if not host_ssh:
            sshmap_logger.error(f"Could not establish SSH session to {hostname}")
            return None
        
        sshmap_logger.display(f"Running module '{module_name}' on {hostname}")
        
        # Run the module
        results = await module_runner.run_module(module_name, host_ssh, save_results=True)
        
        return results
        
    except Exception as e:
        sshmap_logger.error(f"Failed to run module on {hostname}: {e}")
        return None


async def run_multiple_modules_on_host(
    hostname: str,
    module_names: list,
    local_hostname: str,
    credential_store: CredentialStore,
    module_runner: ModuleRunner
):
    """
    Run multiple post-exploitation modules on a specific host.
    """
    try:
        # Get SSH session to the target
        ssh_session_manager = SSHSessionManager(
            graphdb=graph, credential_store=credential_store
        )
        host_ssh = await ssh_session_manager.get_session(hostname, local_hostname)
        
        if not host_ssh:
            sshmap_logger.error(f"Could not establish SSH session to {hostname}")
            return None
        
        sshmap_logger.display(f"Running {len(module_names)} modules on {hostname}")
        
        # Run the modules
        results = await module_runner.run_multiple_modules(
            module_names, host_ssh, save_results=True
        )
        
        return results
        
    except Exception as e:
        sshmap_logger.error(f"Failed to run modules on {hostname}: {e}")
        return None


def display_module_results(results: dict):
    """
    Display module results in a nice format.
    """
    if not results:
        return
    
    # Check if it's combined results or single module
    if 'modules' in results:
        # Combined results
        console.print(f"\n[bold green]Results for {results['hostname']}[/bold green]")
        console.print(f"Timestamp: {results['timestamp']}")
        console.print(f"Summary: {results['summary']['successful']} successful, {results['summary']['failed']} failed\n")
        
        for module_name, module_result in results['modules'].items():
            console.print(f"[bold cyan]Module: {module_name}[/bold cyan]")
            if module_result.get('success'):
                console.print(JSON(json.dumps(module_result.get('data', {})), indent=2))
            else:
                console.print(f"[red]Error: {module_result.get('error', 'Unknown error')}[/red]")
            console.print()
    else:
        # Single module result
        console.print(f"\n[bold green]Module: {results.get('module', 'unknown')}[/bold green]")
        console.print(f"Host: {results.get('hostname', 'unknown')}")
        console.print(f"Timestamp: {results.get('timestamp', 'N/A')}")
        
        if results.get('success'):
            console.print("[green]Status: Success[/green]")
            console.print("\n[bold]Results:[/bold]")
            console.print(JSON(json.dumps(results.get('data', {})), indent=2))
        else:
            console.print(f"[red]Status: Failed[/red]")
            console.print(f"[red]Error: {results.get('error', 'Unknown error')}[/red]")


def list_modules(module_runner: ModuleRunner):
    """
    List all available post-exploitation modules.
    """
    modules = module_runner.list_available_modules()
    
    if not modules:
        console.print("[yellow]No post-exploitation modules found[/yellow]")
        console.print("[yellow]Modules should be placed in modules/postexploit/modules/[/yellow]")
        return
    
    table = Table(title="Available Post-Exploitation Modules")
    table.add_column("Name", style="cyan")
    table.add_column("Class", style="green")
    table.add_column("Description", style="white")
    
    for module in modules:
        table.add_row(
            module['name'],
            module['class'],
            module.get('description', 'No description')[:60]
        )
    
    console.print(table)


async def async_main(args):
    """Main async function."""
    setup_debug_logging()
    
    # Get local hostname
    local_hostname = None
    try:
        result = subprocess.run(
            ["hostname"], capture_output=True, text=True, check=True
        )
        local_hostname = result.stdout.strip()
        sshmap_logger.display(f"Local hostname: {local_hostname}")
    except Exception as e:
        sshmap_logger.error(f"Failed to get local hostname: {e}")
        return
    
    # Initialize credential store and module runner
    credential_store = CredentialStore(args.credentialspath)
    module_runner = ModuleRunner(output_dir=args.output)
    
    # Handle list command
    if args.list:
        list_modules(module_runner)
        return
    
    # Validate that we have a hostname and module
    if not args.hostname:
        sshmap_logger.error("--hostname is required when running modules")
        return
    
    if not args.module and not args.all_modules:
        sshmap_logger.error("Either --module or --all-modules is required")
        return
    
    try:
        # Run single or multiple modules
        if args.all_modules:
            # Get all available module names
            modules = module_runner.list_available_modules()
            module_names = [m['name'] for m in modules]
            
            if not module_names:
                sshmap_logger.error("No modules available to run")
                return
            
            results = await run_multiple_modules_on_host(
                args.hostname,
                module_names,
                local_hostname,
                credential_store,
                module_runner
            )
        else:
            results = await run_module_on_host(
                args.hostname,
                args.module,
                local_hostname,
                credential_store,
                module_runner
            )
        
        # Display results
        if not args.quiet and results:
            display_module_results(results)
        
        if results:
            sshmap_logger.success("Post-exploitation complete")
        else:
            sshmap_logger.error("Post-exploitation failed")
            
    except Exception as e:
        sshmap_logger.error(f"An error occurred: {e}")
    finally:
        graph.close()


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(
        description="SSHMAP Post-Exploitation Module Runner",
        formatter_class=argparse.RawTextHelpFormatter
    )
    
    parser.add_argument(
        "--list",
        action="store_true",
        help="List all available post-exploitation modules"
    )
    
    parser.add_argument(
        "--hostname",
        help="Target hostname to run modules on"
    )
    
    parser.add_argument(
        "--module",
        help="Name of the module to run"
    )
    
    parser.add_argument(
        "--all-modules",
        action="store_true",
        help="Run all available modules on the target"
    )
    
    parser.add_argument(
        "--credentialspath",
        default="wordlists/credentials.csv",
        help="Path to CSV credentials file"
    )
    
    parser.add_argument(
        "--output",
        default="output/postexploit",
        help="Output directory for module results"
    )
    
    parser.add_argument(
        "--quiet",
        action="store_true",
        help="Suppress output display (still saves to files)"
    )
    
    parser.add_argument(
        "--debug",
        action="store_true",
        help="Enable debug logging"
    )
    
    args = parser.parse_args()
    
    # Check Neo4j connectivity
    try:
        graph.driver.verify_connectivity()
    except Exception as e:
        sshmap_logger.error(
            f"Neo4J connectivity check failed, check if it is running: {e}"
        )
        return
    
    # Run async main
    asyncio.run(async_main(args))


if __name__ == "__main__":
    if sys.platform.startswith("win"):
        import asyncio.windows_events
        asyncio.set_event_loop_policy(asyncio.WindowsProactorEventLoopPolicy())
    main()
